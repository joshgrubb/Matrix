{% extends "base.html" %}

{% block title %}Audit Logs — Admin{% endblock %}

{% block content %}
<div class="pm-page-header">
    <div>
        <h1><i class="bi bi-journal-text me-2"></i>Audit Logs</h1>
        <p>Track all data changes, logins, and system actions.</p>
    </div>
</div>

{# ── Filter bar ── #}
<div class="pm-card mb-3">
    <div class="card-body py-3">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="action_type" class="pm-form-label">Action Type</label>
                <select name="action_type" id="action_type" class="form-select">
                    <option value="">All Actions</option>
                    <option value="CREATE" {% if selected_action=='CREATE' %}selected{% endif %}>CREATE</option>
                    <option value="UPDATE" {% if selected_action=='UPDATE' %}selected{% endif %}>UPDATE</option>
                    <option value="DELETE" {% if selected_action=='DELETE' %}selected{% endif %}>DELETE</option>
                    <option value="LOGIN" {% if selected_action=='LOGIN' %}selected{% endif %}>LOGIN</option>
                    <option value="LOGOUT" {% if selected_action=='LOGOUT' %}selected{% endif %}>LOGOUT</option>
                    <option value="SYNC" {% if selected_action=='SYNC' %}selected{% endif %}>SYNC</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="entity_type" class="pm-form-label">Entity Type</label>
                <select name="entity_type" id="entity_type" class="form-select">
                    <option value="">All Entities</option>
                    {% for et in entity_types %}
                    <option value="{{ et }}" {% if selected_entity==et %}selected{% endif %}>{{ et }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button type="submit" class="pm-btn pm-btn-primary pm-btn-sm">
                    <i class="bi bi-funnel"></i>
                    Filter
                </button>
                {% if selected_action or selected_entity or selected_user_id %}
                <a href="{{ url_for('admin.audit_logs') }}" class="pm-btn pm-btn-secondary pm-btn-sm">
                    Clear
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

{# ── Audit log table ── #}
<div class="pm-card">
    <div class="table-responsive">
        {% if logs.items %}
        <table class="table pm-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Entity</th>
                    <th>Entity ID</th>
                    <th>IP Address</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs.items %}
                <tr>
                    <td>
                        <small>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                    </td>
                    <td>
                        {% if log.user %}
                        {{ log.user.full_name }}
                        {% else %}
                        <span class="pm-text-muted">System</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.action_type == 'CREATE' %}
                        <span class="pm-badge pm-badge-success">CREATE</span>
                        {% elif log.action_type == 'UPDATE' %}
                        <span class="pm-badge pm-badge-info">UPDATE</span>
                        {% elif log.action_type == 'DELETE' %}
                        <span class="pm-badge pm-badge-danger">DELETE</span>
                        {% elif log.action_type == 'LOGIN' %}
                        <span class="pm-badge pm-badge-info">LOGIN</span>
                        {% elif log.action_type == 'LOGOUT' %}
                        <span class="pm-badge pm-badge-neutral">LOGOUT</span>
                        {% else %}
                        <span class="pm-badge pm-badge-warning">{{ log.action_type }}</span>
                        {% endif %}
                    </td>
                    <td>{{ log.entity_type }}</td>
                    <td class="pm-text-muted">{{ log.entity_id or '—' }}</td>
                    <td class="pm-text-muted"><small>{{ log.ip_address or '—' }}</small></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {# Pagination #}
        {% if logs.pages > 1 %}
        {% include "components/_pagination.html" %}
        {% endif %}
        {% else %}
        <div class="pm-empty-state">
            <i class="bi bi-journal-text d-block"></i>
            <p>No audit log entries match the current filters.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}