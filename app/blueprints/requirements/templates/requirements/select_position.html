{% extends "base.html" %}

{% block title %}Select Position — Requirements{% endblock %}

{% block content %}
<div class="pm-page-header">
    <div>
        <h1><i class="bi bi-list-check me-2"></i>Configure Position Requirements</h1>
        <p>Select a position to configure its hardware and software requirements.</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="pm-card">
            <div class="card-header">
                <i class="bi bi-1-circle me-2"></i>Step 1: Select a Position
            </div>
            <div class="card-body" style="padding: 1.5rem;">
                <p class="pm-text-muted mb-4">
                    Choose a department, then a division, then a position. Each dropdown
                    narrows your selection.
                </p>
                <form method="GET" id="position-select-form">

                    {# -- Department dropdown -- #}
                    {# NOTE: No hx-* attributes here. JavaScript below drives the
                    HTMX requests via htmx.ajax() so the correct ID is always
                    included in the URL path. This avoids the race condition
                    where HTMX fired the request with the stale placeholder
                    URL (department_id=0) before JS could update it. #}
                    <div class="mb-3">
                        <label for="department_id" class="pm-form-label">
                            Department <span class="pm-required">*</span>
                        </label>
                        <select name="department_id" id="department_id" class="form-select">
                            <option value="">— Select Department —</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">
                                {{ dept.department_code }} — {{ dept.department_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    {# -- Division dropdown (populated via HTMX) -- #}
                    <div class="mb-3">
                        <label for="division_id" class="pm-form-label">
                            Division <span class="pm-required">*</span>
                        </label>
                        <select name="division_id" id="division_id" class="form-select">
                            <option value="">— Select Division —</option>
                        </select>
                    </div>

                    {# -- Position dropdown (populated via HTMX) -- #}
                    <div class="mb-4">
                        <label for="position_id" class="pm-form-label">
                            Position <span class="pm-required">*</span>
                        </label>
                        <select name="position_id" id="position_id" class="form-select">
                            <option value="">— Select Position —</option>
                        </select>
                    </div>

                    <button type="button" id="btn-next" class="pm-btn pm-btn-primary" onclick="goToHardware()">
                        Next: Select Hardware
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

    /* -- Department → Division cascade -- */
    document.getElementById('department_id').addEventListener('change', function () {
        var deptId = this.value;

        /* Always reset downstream dropdowns when department changes. */
        document.getElementById('division_id').innerHTML =
            '<option value="">— Select Division —</option>';
        document.getElementById('position_id').innerHTML =
            '<option value="">— Select Position —</option>';

        if (deptId) {
            /* Fetch division options and swap them into the division select. */
            htmx.ajax('GET', '/org/htmx/divisions/' + deptId, {
                target: '#division_id',
                swap: 'innerHTML'
            });
        }
    });

    /* -- Division → Position cascade -- */
    document.getElementById('division_id').addEventListener('change', function () {
        var divId = this.value;

        /* Always reset the position dropdown when division changes. */
        document.getElementById('position_id').innerHTML =
            '<option value="">— Select Position —</option>';

        if (divId) {
            /* Fetch position options and swap them into the position select. */
            htmx.ajax('GET', '/org/htmx/positions/' + divId, {
                target: '#position_id',
                swap: 'innerHTML'
            });
        }
    });

    /**
     * Navigate to the hardware selection page for the chosen position.
     */
    function goToHardware() {
        var posId = document.getElementById('position_id').value;
        if (!posId) {
            alert('Please select a position first.');
            return;
        }
        window.location.href = '{{ url_for("requirements.select_position") }}' + 'position/' + posId + '/hardware';
    }
</script>
{% endblock %}