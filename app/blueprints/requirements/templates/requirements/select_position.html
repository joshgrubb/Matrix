{% extends "base.html" %}

{% block title %}Select Position — Position Equipment{% endblock %}

{% block content %}
{# ── Shared wizard header (matches Steps 2–4 layout) ── #}
{% set current_step = 1 %}
{% set step_title = "Choose Position" %}
{% set header_title = "Set Up Position Equipment" %}
{% set header_subtitle = "Select a position to set up its equipment and software." %}
{% include "requirements/_position_header.html" %}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="pm-card">
            <div class="card-header">
                <i class="bi bi-1-circle me-2"></i>Step 1: Select a Position
            </div>
            <div class="card-body" style="padding: 1.5rem;">
                <p class="pm-text-muted mb-4">
                    Choose a department, then a division, then a position. Each dropdown
                    narrows your selection.
                </p>
                <form method="GET" id="position-select-form">

                    {# -- Department dropdown -- #}
                    <div class="mb-3">
                        <label for="department_id" class="pm-form-label">
                            Department <span class="pm-required">*</span>
                        </label>
                        <select name="department_id" id="department_id" class="form-select">
                            <option value="">— Select Department —</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">
                                {{ dept.department_code }} — {{ dept.department_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    {# -- Division dropdown (populated via HTMX) -- #}
                    <div class="mb-3">
                        <label for="division_id" class="pm-form-label">
                            Division <span class="pm-required">*</span>
                        </label>
                        <select name="division_id" id="division_id" class="form-select">
                            <option value="">— Select Division —</option>
                        </select>
                    </div>

                    {# -- Position dropdown (populated via HTMX) -- #}
                    <div class="mb-4">
                        <label for="position_id" class="pm-form-label">
                            Position <span class="pm-required">*</span>
                        </label>
                        <select name="position_id" id="position_id" class="form-select">
                            <option value="">— Select Position —</option>
                        </select>
                    </div>

                    {# Tier 1: Updated button label. #}
                    <button type="button" id="btn-next" class="pm-btn pm-btn-primary" onclick="goToHardware()">
                        Next: Select Equipment
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </form>

                {# ── Tier 2 (#8): Copy from another position ── #}
                <hr class="my-4">
                <div id="copy-from-section">
                    <h6 class="mb-2">
                        <i class="bi bi-copy me-1"></i>
                        Or, copy equipment from an existing position
                    </h6>
                    <p class="pm-text-muted" style="font-size: 0.85rem;">
                        If another position already has the equipment setup you need,
                        you can copy it and then customize. Select a division above
                        first to see available positions.
                    </p>
                    <div class="mb-3">
                        <label for="copy_source_id" class="pm-form-label">
                            Copy from
                        </label>
                        <select name="copy_source_id" id="copy_source_id" class="form-select" disabled>
                            <option value="">— Select a division first —</option>
                        </select>
                    </div>
                    <button type="button" id="btn-copy" class="pm-btn pm-btn-secondary" onclick="copyFromPosition()"
                        disabled>
                        <i class="bi bi-copy me-1"></i>
                        Copy &amp; Customize
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    /* -- Department → Division cascade -- */
    document.getElementById('department_id').addEventListener('change', function () {
        var deptId = this.value;

        /* Always reset downstream dropdowns when department changes. */
        document.getElementById('division_id').innerHTML =
            '<option value="">— Select Division —</option>';
        document.getElementById('position_id').innerHTML =
            '<option value="">— Select Position —</option>';

        /* Tier 2: Also reset the copy-from dropdown. */
        var copySelect = document.getElementById('copy_source_id');
        copySelect.innerHTML = '<option value="">— Select a division first —</option>';
        copySelect.disabled = true;
        document.getElementById('btn-copy').disabled = true;

        if (deptId) {
            htmx.ajax('GET', '/org/htmx/divisions/' + deptId, {
                target: '#division_id',
                swap: 'innerHTML'
            });
        }
    });

    /* -- Division → Position cascade + copy-from loader -- */
    document.getElementById('division_id').addEventListener('change', function () {
        var divId = this.value;

        /* Always reset the position dropdown when division changes. */
        document.getElementById('position_id').innerHTML =
            '<option value="">— Select Position —</option>';

        /* Tier 2: Reset and repopulate the copy-from dropdown. */
        var copySelect = document.getElementById('copy_source_id');
        copySelect.innerHTML = '<option value="">— Loading... —</option>';
        copySelect.disabled = true;
        document.getElementById('btn-copy').disabled = true;

        if (divId) {
            /* Fetch position options for the target dropdown. */
            htmx.ajax('GET', '/org/htmx/positions/' + divId, {
                target: '#position_id',
                swap: 'innerHTML'
            });

            /* Tier 2 (#8): Fetch positions with existing requirements
               for the copy-from dropdown. */
            htmx.ajax('GET', '/requirements/htmx/positions-with-requirements/' + divId, {
                target: '#copy_source_id',
                swap: 'innerHTML'
            }).then(function () {
                copySelect.disabled = false;
            });
        } else {
            copySelect.innerHTML = '<option value="">— Select a division first —</option>';
        }
    });

    /* Tier 2 (#8): Enable copy button when a source is selected. */
    document.getElementById('copy_source_id').addEventListener('change', function () {
        document.getElementById('btn-copy').disabled = !this.value;
    });

    /**
     * Navigate to the equipment selection page for the chosen position.
     */
    function goToHardware() {
        var posId = document.getElementById('position_id').value;
        if (!posId) {
            alert('Please select a position first.');
            return;
        }
        window.location.href = '{{ url_for("requirements.select_position") }}' + 'position/' + posId + '/hardware';
    }

    /**
     * Tier 2 (#8): Copy equipment from a source position to the target,
     * then redirect to the equipment page for customization.
     *
     * Uses a form POST to the copy_requirements route so that CSRF
     * protection and scope checks are enforced server-side.
     */
    function copyFromPosition() {
        var targetId = document.getElementById('position_id').value;
        var sourceId = document.getElementById('copy_source_id').value;

        if (!targetId) {
            alert('Please select a target position first.');
            return;
        }
        if (!sourceId) {
            alert('Please select a position to copy from.');
            return;
        }
        if (targetId === sourceId) {
            alert('The target and source positions are the same. Please choose a different position to copy from.');
            return;
        }

        /* Confirm before overwriting. */
        var confirmed = confirm(
            'This will replace any existing equipment on the target position ' +
            'with equipment from the selected source.\n\n' +
            'You can review and adjust everything on the next screen.\n\n' +
            'Continue?'
        );
        if (!confirmed) { return; }

        /* Create and submit a hidden form for the POST. */
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("requirements.select_position") }}' +
            'position/' + targetId + '/copy-from/' + sourceId;

        /* Include CSRF token. */
        var csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}